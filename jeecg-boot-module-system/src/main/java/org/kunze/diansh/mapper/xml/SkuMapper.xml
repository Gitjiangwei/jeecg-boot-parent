<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kunze.diansh.mapper.SkuMapper">

    <insert id="saveSku">
        insert into kz_sku(id,spu_id,title,images,new_price,price,indexes,own_spec,create_time,last_update_time,update_name,shop_id)
        values
        <foreach collection="skuList" item="item" separator=",">
            (#{item.id},#{item.spuId},#{item.title},#{item.images},#{item.newPrice},#{item.price},#{item.indexes},#{item.ownSpec},
            NOW(),NOW(),#{item.updateName},#{item.shopId})
        </foreach>
    </insert>

    <update id="updateSku">
        <foreach collection="skuList" item="sku" separator=";">
            update kz_sku
            <set>
                <if test="sku.spuId !=null and sku.spuId != ''">spu_id=#{sku.spuId},</if>
                <if test="sku.title !=null and sku.title != ''">title=#{sku.title},</if>
                <if test="sku.images !=null and sku.images != ''">images=#{sku.images},</if>
                <if test="sku.newPrice !=null and sku.images != ''">images=#{sku.newPrice},</if>
                <if test="sku.price !=null and sku.price != ''">price=#{sku.price},</if>
                <if test="sku.indexes !=null and sku.indexes != ''">indexes=#{sku.indexes},</if>
                <if test="sku.ownSpec !=null and sku.ownSpec != ''">own_spec=#{sku.ownSpec},</if>
                <if test="sku.enable !=null and sku.enable != ''">enable=#{sku.enable},</if>
                <if test="sku.lastUpdateTime !=null and sku.lastUpdateTime != ''">last_update_time=NOW(),</if>
                <if test="sku.shopId !=null and sku.shopId != ''">shop_id=#{sku.shopId},</if>
                <if test="sku.updateName !=null and sku.updateName != ''">update_name=#{sku.updateName}</if>
            </set>
            where id = #{sku.id}
        </foreach>
    </update>

    <select id="querySkuById" resultType="org.kunze.diansh.entity.Sku">
        SELECT
	id,
	sku.spu_id,
	title,
	images,
	CASE sku.is_features
	WHEN '1' THEN
	feat.features_price
	ELSE
	sku.new_price
	END AS 'newPrice',
	price,
	indexes,
	own_spec,
	`enable`,
	sku.create_time,
	last_update_time,
	sku.shop_id,
	update_name,
	CASE sku.is_features
	WHEN '1' THEN
	'特卖'
	ELSE
	''
	END AS 'isFeatures'
FROM
	kz_sku sku
LEFT JOIN kz_spu_features feat ON sku.id = feat.sku_id
WHERE
	`enable` = 1
AND sku.spu_id = #{id}
    </select>

    <!--查询商品基本信息 通过skuid-->
    <select id="querySkuInfoById"  resultType="org.kunze.diansh.entity.Sku">
        select id,spu_id,title,images,price,indexes,own_spec,`enable`,create_time,last_update_time,shop_id,update_name
        from kz_sku where `enable`=1 and id = #{id}
    </select>

    <select id="querySkuBySpuId" resultType="org.kunze.diansh.entity.Sku">
      select id,sku.spu_id,title,images,new_price,
    CASE sku.is_features
	WHEN '1' THEN
	feat.features_price
	ELSE
	sku.new_price
	END AS 'newPrice',
	price,
      indexes,own_spec,`enable`,sku.create_time,last_update_time,sku.shop_id,update_name,
      	CASE sku.is_features
	WHEN '1' THEN
	'特卖'
	ELSE
	''
	END AS 'isFeatures'
        from kz_sku sku
        LEFT JOIN kz_spu_features feat ON sku.id = feat.sku_id
        where `enable`=1 and sku.spu_id = #{spuId}
    </select>

    <!-- 查询商品展示的详细信息 通过spuId -->
    <select id="selectSkuInfoBySpuId" parameterType="java.lang.String" resultType="java.util.HashMap">
        SELECT
        SKU.ID,
        SKU.SPU_ID,
        SKU.TITLE,
        SKU.IMAGES,
        SKU.INDEXES,
        SKU.OWN_SPEC,
        SKU.NEW_PRICE,
        KSD.PACKING_LIST,
        KSD.AFTER_SERVICE,
        KSD.DESCRIPTION,
        KS.STOCK,
        SPU.CID1,
        SPU.CID2,
        SPU.CID3
        FROM
        KZ_SKU SKU
        LEFT JOIN KZ_SPU SPU ON SKU.SPU_ID = SPU.ID
        LEFT JOIN KZ_SPU_DETAIL KSD ON SPU.ID = KSD.SPU_ID
        LEFT JOIN KZ_STOCK KS ON SKU.ID = KS.SKU_ID
        WHERE
        `ENABLE` = 1
        AND SKU.SPU_ID = #{spuId}
    </select>

</mapper>